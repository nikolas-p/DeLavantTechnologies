@using MongoDB.Bson
@rendermode InteractiveServer
@inject ITestService TestService
@inject IQuestionService QuestionService
@inject IStepService StepService

<div class="border p-3 mb-2">
    <EditForm Model="@Step" OnValidSubmit="SaveStepWithElements" FormName="@FormName">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-2">
            <label class="form-label">Название раздела</label>
            <InputText class="form-control" @bind-Value="Step.Title" />
        </div>

        <div class="mb-2">
            <label class="form-label">Описание раздела</label>
            <InputTextArea class="form-control" @bind-Value="Step.Description" />
        </div>

        <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success btn-sm">Сохранить</button>
            <button type="button" class="btn btn-danger btn-sm ms-2" @onclick="Delete">Удалить</button>
        </div>
    </EditForm>

    <div class="mt-3">
        <button class="btn btn-outline-primary btn-sm" @onclick="AddLecture" type="button">Добавить лекцию</button>
        <button class="btn btn-outline-primary btn-sm ms-2" @onclick="AddTest" type="button">Добавить тест</button>
    </div>

    <div class="mt-3">
        @foreach (var el in Step.Elements)
        {
            <DynamicComponent Type="Resolve(el.IsTest)"
                              Parameters="@(new Dictionary<string, object?>
    {
        ["Id"] = el.Id,
        ["OnDeleted"] = EventCallback.Factory.Create<string>(
            this,
            id => OnTestDeleted(id)
        )
    })" />

        }

        @code {
            private Type Resolve(bool isTest) => isTest ? typeof(TestEdit) : typeof(LectureEdit);
        }
    </div>
</div>

@code {
    [Parameter] public Step Step { get; set; }
    [Parameter] public EventCallback<Step> OnStepUpdated { get; set; }
    [Parameter] public EventCallback<Step> OnStepDeleted { get; set; }

    private string FormName => $"StepForm_{Step.Id}";

    private async Task SaveStepWithElements()
    {
        // 1. Сохраняем все элементы Step
        foreach (var el in Step.Elements)
        {
            if (el.IsTest)
            {
                // Получаем тест
                var test = await TestService.GetTestByIdAsync(el.Id) ?? new Test { Id = el.Id };

                // Получаем вопросы
                var questions = test.Questions != null && test.Questions.Any()
                    ? await QuestionService.GetQuestionsByIdsAsync(test.Questions)
                    : new List<Question>();

                // Сохраняем каждый вопрос
                foreach (var q in questions)
                {
                    if (await QuestionService.GetQuestionByIdAsync(q.Id) != null)
                        await QuestionService.UpdateQuestionAsync(q);
                    else
                        await QuestionService.CreateQuestionAsync(q);
                }

                // Синхронизация списка ID вопросов
                test.Questions = questions.Select(q => q.Id).ToList();

                // Сохраняем сам тест
                if (string.IsNullOrEmpty(test.Id))
                    await TestService.CreateTestAsync(test);
                else
                    await TestService.UpdateTestAsyc(test);
            }
            else
            {
                // Лекции можно сохранять аналогично через LectureService
            }
        }

        // 2. Сохраняем Step
        if (string.IsNullOrEmpty(Step.Id))
            await StepService.CreateStepAsync(Step);
        else
            await StepService.UpdateStepAsync(Step);

        // 3. Уведомляем родительский компонент (CourseEdit)
        await OnStepUpdated.InvokeAsync(Step);
    }

    private async Task Delete()
    {
        // При удалении Step можно удалить и все элементы
        foreach (var el in Step.Elements)
        {
            if (el.IsTest)
            {
                var test = await TestService.GetTestByIdAsync(el.Id);
                if (test != null)
                {
                    // Удаляем все вопросы
                    if (test.Questions != null)
                    {
                        foreach (var qId in test.Questions)
                        {
                            await QuestionService.DeleteQuestionAsync(qId);
                        }
                    }

                    // Удаляем тест
                    await TestService.DeleteTestAsync(test.Id);
                }
            }
            else
            {
                // Лекции удаляем через LectureService
            }
        }

        await OnStepDeleted.InvokeAsync(Step);
    }

    private async Task AddLecture()
    {
        // Создание лекции через LectureService
        Console.WriteLine("Имитация создания лекции");
    }


    private async Task AddTest()
    {
        var test = new Test();
        await TestService.CreateTestAsync(test);

        Step.Elements.Add(new StepElement
            {
                Id = test.Id,
                IsTest = true
            });
    }

    private void OnTestDeleted(string testId)
    {
        var element = Step.Elements.FirstOrDefault(e => e.Id == testId);
        if (element != null)
        {
            Step.Elements.Remove(element);
            StateHasChanged(); // 🔥 тест исчезает сразу
        }
    }

}
