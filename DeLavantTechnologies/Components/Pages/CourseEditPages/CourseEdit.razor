@page "/course/edit"
@page "/courses/create"
@page "/course/edit/{Id}"
@inject ICourseService CourseService
@inject IStepService StepService
@inject ITestService TestService
@inject IQuestionService QuestionService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@layout AuthLayout
@inject UiState Ui
@using DeLavantTechnologies.Data
@using Microsoft.AspNetCore.Authorization
@using MongoDB.Bson
@attribute [Authorize]



<div class="auth-toolbar title">

    <div class="toolbar-block left">

        @if (EntityNavDefinitions.EntityNavMap.TryGetValue(Ui.Entity, out var info))
        {
            <div class="nav-link"
                 style="@info.Style"
                 role="button"
                 tabindex="0"
                 @onclick="GoToAuth">

                <span class="square-icon @info.IconClass"></span>
                <span class="nav-text">@info.Title</span>

            </div>
        }
    </div>

    @code {
        private void GoToAuth()
        {
            Ui.SetMode(PageMode.List);

            // Entity НЕ трогаем — она уже выбрана
            Navigation.NavigateTo("/Auth");
        }
    }


    <div class="toolbar-block center">
        <div>
            <h3>@(IsNew ? "Создание курса" : "Редактирование курса")</h3>
        </div>
    </div>
    <div class="toolbar-block right">
        <button class="square-button filter-icon"
                @onclick="Ui.ToggleRight"></button>
    </div>
</div>

<main role="main" class="auth-shell-content">


<div class="item-content">
    <EditForm Model="@Course" OnValidSubmit="SaveCourse" FormName="CourseForm">

        
    
    <!-- HEADER -->
    <div class="item-content-header">
        <div class="item-content-header-left">
           
        </div>

        <div class="item-content-header-center">
           
        </div>

        <div class="item-content-header-right">
           <button class="circle-button primary-purple check-circle-fill-icon" type="submit"></button>
        </div>
    </div>

    <!-- MAIN -->
    <div class="item-content-main">
       
        <InputText class="form-control" @bind-Value="Course.Title" aria-placeholder="Название курса"/>
        
        <InputTextArea class="form-control" @bind-Value="Course.Description" aria-placeholder="описание по желанию" />
        

   
    @if (Steps.Any())
    {
        <h4>Разделы курса</h4>
        @foreach (var step in Steps)
        {
            
                <StepEdit Step="@step"
                          OnStepUpdated="SaveStep"
                          OnStepDeleted="DeleteStep" />
            
        }
    }
    </div>

    <!-- FOOTER -->
    <div class="item-content-footer">
        <div class="item-content-footer-left">
           
        </div>

        <div class="item-content-footer-center">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <button class="btn btn-secondary ms-2" type="button" @onclick="AddStep">Добавить раздел</button>
        </div>

        <div class="item-content-footer-right">
           
        </div>
    </div>
       
</EditForm>
</div>
</main>



@code {

    [Parameter] public string? Id { get; set; }

    private Course Course { get; set; } = new Course
        {
            Title = "",
            Description = "",
            Elements = new List<string>(),
            Access = new List<string>(),
            CreatedAt = DateTime.UtcNow,
            LastUpdatedAt = DateTime.UtcNow
        };

    private List<Step> Steps { get; set; } = new();

    private bool IsNew => string.IsNullOrEmpty(Id);

   
              public void Dispose()
        {
            // при уходе со страницы возвращаем List
            Ui.SetMode(PageMode.List);
        }
    


    protected override async Task OnInitializedAsync()
    {

         Ui.SetMode(PageMode.Edit);



        if (!IsNew)
        {
            var courseTask = CourseService.GetCourseByIdAsync(Id);
            await courseTask;
            if (courseTask.Result != null)
            {
                Course = courseTask.Result;
                Course.Elements ??= new List<string>();

                // Получаем шаги только если есть элементы
                if (Course.Elements.Count > 0)
                    Steps = await StepService.GetStepsByIdsAsync(Course.Elements);
            }
        }
    }

    private async Task AddStep()
    {
        var step = new Step();
        Steps.Add(step);

        Course.Elements ??= new List<string>();
        Course.Elements.Add(step.Id);

        // Сохраняем новый шаг в базе
        await StepService.CreateStepAsync(step);
    }


    private async Task SaveStep(Step step)
    {
        if (Steps.Any(s => s.Id == step.Id))
            await StepService.UpdateStepAsync(step);
        else
            await StepService.CreateStepAsync(step);
    }

    private async Task DeleteStep(Step step)
    {
        // 1. Удаляем все элементы шага
        foreach (var el in step.Elements)
        {
            if (el.IsTest)
            {
                // Получаем тест
                var test = await TestService.GetTestByIdAsync(el.Id);
                if (test != null)
                {
                    // Удаляем все вопросы теста
                    if (test.Questions != null)
                    {
                        foreach (var qid in test.Questions)
                        {
                            await QuestionService.DeleteQuestionAsync(qid);
                        }
                    }

                    // Удаляем тест
                    await TestService.DeleteTestAsync(el.Id);
                }
            }
            else
            {
                // Если лекция — удаляем через LectureService
                // await LectureService.DeleteLectureAsync(el.Id);
            }
        }

        // 2. Удаляем сам Step
        Steps.Remove(step);
        Course.Elements?.Remove(step.Id);
        await StepService.DeleteStepAsync(step.Id);
    }


    private async Task SaveCourse()
    {
      

        if (IsNew)
        {
            Course.CreatedAt = DateTime.UtcNow;
            Course.LastUpdatedAt = DateTime.UtcNow;
        }
        else
        {
            
            Course.LastUpdatedAt = DateTime.UtcNow;
        }
        // 1. Сохраняем все Steps
        foreach (var step in Steps)
        {
            // Сохраняем все элементы Step
            foreach (var el in step.Elements)
            {
                if (el.IsTest)
                {
                    // Получаем тест из базы или создаем новый
                    Test test;
                    if (!string.IsNullOrEmpty(el.Id))
                    {
                        test = await TestService.GetTestByIdAsync(el.Id) ?? new Test();
                    }
                    else
                    {
                        test = new Test();
                        el.Id = test.Id;
                    }

                    // Сохраняем вопросы теста
                    if (test.Questions != null)
                    {
                        for (int i = 0; i < test.Questions.Count; i++)
                        {
                            var questionId = test.Questions[i];
                            Question q;

                            if (!string.IsNullOrEmpty(questionId))
                            {
                                q = await QuestionService.GetQuestionByIdAsync(questionId) ?? new Question();
                                q.Id = questionId;
                            }
                            else
                            {
                                q = new Question();
                                q.Id = ObjectId.GenerateNewId().ToString();
                                test.Questions[i] = q.Id; // сохраняем ссылку в тесте
                            }

                            // Если Answers == null
                            q.Answers ??= new List<Answer>();

                            // Сохраняем вопрос
                            if (string.IsNullOrEmpty(questionId))
                                await QuestionService.CreateQuestionAsync(q);
                            else
                                await QuestionService.UpdateQuestionAsync(q);
                        }
                    }
                    else
                    {
                        test.Questions = new List<string>();
                    }

                    // Сохраняем сам тест
                    if (string.IsNullOrEmpty(el.Id))
                        await TestService.CreateTestAsync(test);
                    else
                        await TestService.UpdateTestAsyc(test);
                }
                else
                {
                    // Лекции можно добавить аналогично
                    // var lecture = await LectureService.GetLectureByIdAsync(el.Id);
                    // if (lecture != null) await LectureService.UpdateLectureAsync(lecture);
                }
            }

            // 2. Сохраняем Step
            if (string.IsNullOrEmpty(step.Id))
            {
                step.Id = ObjectId.GenerateNewId().ToString();
                await StepService.CreateStepAsync(step);

                Course.Elements ??= new List<string>();
                Course.Elements.Add(step.Id); // добавляем в курс
            }
            else
            {
                await StepService.UpdateStepAsync(step);
            }
        }

        // 3. Удаляем Step, которых нет в списке Steps
        if (Course.Elements != null)
        {
            var existingStepIds = Steps.Select(s => s.Id).ToList();
            var removedIds = Course.Elements.Where(id => !existingStepIds.Contains(id)).ToList();

            foreach (var removedId in removedIds)
            {
                // Удаляем Step и все его элементы
                var stepToDelete = await StepService.GetStepByIdAsync(removedId);
                if (stepToDelete != null)
                {
                    foreach (var el in stepToDelete.Elements)
                    {
                        if (el.IsTest)
                        {
                            var test = await TestService.GetTestByIdAsync(el.Id);
                            if (test?.Questions != null)
                            {
                                foreach (var qId in test.Questions)
                                    await QuestionService.DeleteQuestionAsync(qId);
                            }
                            if (test != null)
                                await TestService.DeleteTestAsync(el.Id);
                        }
                        else
                        {
                            // Удаляем лекцию
                            // await LectureService.DeleteLectureAsync(el.Id);
                        }
                    }
                }

                await StepService.DeleteStepAsync(removedId);
                Course.Elements.Remove(removedId);
            }
        }
       
        // 4. Сохраняем сам курс
        if (IsNew)
            await CourseService.CreateCourseAsync(Course);
        else
            await CourseService.UpdateCourseAsync(Course);


        // 5. Навигация обратно к списку
        Ui.SetMode(PageMode.List);

        // Entity НЕ трогаем — она уже выбрана
        Navigation.NavigateTo("/Auth");
    }


}
