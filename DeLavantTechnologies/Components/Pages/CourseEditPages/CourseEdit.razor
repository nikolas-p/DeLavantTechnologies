@page "/courses/edit"
@page "/courses/edit/{Id}"
@inject ICourseService CourseService
@inject IStepService StepService
@inject ITestService TestService
@inject IQuestionService QuestionService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@layout AuthLayout
@inject UiState Ui
@inject CourseEditUiState CourseEditUi
@using DeLavantTechnologies.Data
@using DeLavantTechnologies.Components.Pages.CourseEditPages.CourseEditPageComponent
@using Microsoft.AspNetCore.Authorization
@using MongoDB.Bson
@attribute [Authorize]

<div class="auth-toolbar title">
    <div class="toolbar-block left">
        @if (EntityNavDefinitions.EntityNavMap.TryGetValue(Ui.Entity, out var info))
        {
            <div class="nav-link" style="@info.Style" role="button" tabindex="0" @onclick="GoToAuth">
                <span class="square-icon @info.IconClass"></span>
                <span class="nav-text">@info.Title</span>
            </div>
        }
    </div>

    @code {
        private void GoToAuth()
        {

            SaveCourse();
            Ui.SetMode(PageMode.List);
            Navigation.NavigateTo("/Auth");
        }
    }
    <div class="toolbar-block center">
        <div>
            <h3>@(IsNew ? "Создание курса" : "Редактирование курса")</h3>
        </div>
    </div>
    <div class="toolbar-block right">
        <button class="square-button menu-icon" @onclick="()=>CourseEditUi.ToggleRight()" ></button>
    </div>
</div>

<!-- UNDER TOOLBAR -->
<div class="fixed-under-toolbar left">
    <button class="square-button menu-icon" @onclick="()=>CourseEditUi.ToggleLeft()"></button>
</div>


<!-- LEFT ASIDE -->
<div class="fixed-aside left @(CourseEditUi.ShowLeft ? "open" : "")">
    <DynamicComponent Type="@(CourseEditUi.ShowLeft 
    ?  typeof(CourseDragDropOpen) 
    : typeof(CourseDragDrop))" 
    Parameters="@DragDropParameters"/>
</div>
<!-- RIGHT ASIDE -->
<div class="fixed-aside right @(CourseEditUi.ShowRight ? "open" : "")">
    <DynamicComponent Type="@(CourseEditUi.ShowRight 
                            ? typeof(CourseEditActionOpen) 
                            : typeof(CourseEditAction))"
                  Parameters="@RightDynamicComponentParams" />

</div>

<!-- CENTER ASIDE -->
@if (CourseEditUi.ShowAdditional && CurrentAsideComponent is not null)
{
    <div class="fixed-center-aside open">
    <div class="fixed-center-aside-content">
        <div class="fixed-right-aside-close">
            <button class="square-button x-icon"
                    @onclick="CourseEditUi.CloseAdditional">
            </button>
        </div>

        <DynamicComponent Type="@CurrentAsideComponent"
                          Parameters="@AsideParameters" />
    </div>
</div>

}



<main role="main" class="auth-shell-content">
<div class="item-content">
    <EditForm Model="@Course" OnValidSubmit="SaveCourse" FormName="CourseForm">
    <!-- HEADER -->
    <div class="item-content-header">
        <div class="item-content-header-left"></div>

        <div class="item-content-header-center"></div>

        <div class="item-content-header-right">
           <button class="circle-button primary-purple check-circle-fill-icon" type="submit"></button>
        </div>
    </div>

    <!-- MAIN -->
    <div class="item-content-main">
       
        <InputText class="form-control" @bind-Value="Course.Title" aria-placeholder="Название курса"/>
        <InputTextArea class="form-control" @bind-Value="Course.Description" aria-placeholder="описание" />
        
 
    @if (Steps.Any())
    {
        <h4>Разделы курса</h4>
        @foreach (var step in Steps)
        {
                <StepEdit Step="@step"  @key="step.Id" OnStepUpdated="SaveStep" OnStepDeleted="DeleteStep" />  
        }
    }
    </div>

    <!-- FOOTER -->
    <div class="item-content-footer">
        <div class="item-content-footer-left"></div>

        <div class="item-content-footer-center">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <button class="btn btn-secondary ms-2" type="button" @onclick="AddStep">Добавить раздел</button>
        </div>

        <div class="item-content-footer-right"></div>
    </div>
       
</EditForm>
</div>
</main>



@code {

 private Dictionary<string, object> RightDynamicComponentParams => new()
{
    { "IsHidden", Course.IsHidden },
    { "OnToggleHidden", EventCallback.Factory.Create(this, ToggleHidden) }
};

    private Type? CurrentAsideComponent => CourseEditUi.Type switch
    {
        AdditionalPageType.Access => typeof(CourseAccess),
        AdditionalPageType.Delete=> typeof(CourseDelete),
        AdditionalPageType.Statistic => typeof(CourseStatistic),
        _ => null
    };

    private IDictionary<string, object> AsideParameters =>
        new Dictionary<string, object>
        {
            { "CourseId", Id! },
            { "Course", Course },
        };

        private IDictionary<string, object> DragDropParameters => new Dictionary<string, object>
    {
          { "Steps", Steps },
        { "Course", Course },
        { "OnOrderChanged", EventCallback.Factory.Create<List<string>>(this, HandleOrderChanged) }
    };

    private async Task HandleOrderChanged(List<string> newOrder)
    {
    // Обновляем курс
    Course.Elements = newOrder;

    // Автосохранение
    await CourseService.UpdateCourseAsync(Course);
     // Можно переставить Steps по новому порядку
    Steps = newOrder.Select(id => Steps.FirstOrDefault(s => s.Id == id)!).ToList();

    StateHasChanged();
    }
    [Parameter] public string? Id { get; set; }

    private Course Course { get; set; } = new Course
        {
            Title = "",
            Description = "",
            Elements = new List<string>(),
            Access = new List<string>(),
            CreatedAt = DateTime.UtcNow,
            LastUpdatedAt = DateTime.UtcNow,
            IsHidden = false,
            AccessType = ""
        };
    private void ToggleHidden() {
    Course.IsHidden = !Course.IsHidden;
    CourseService.UpdateCourseAsync(Course);
    }


    private List<Step> Steps { get; set; } = new();

    private bool IsNew => string.IsNullOrEmpty(Id);

    protected override void OnInitialized()
{
    CourseEditUi.Changed += OnUiChanged;
}

private void OnUiChanged()
{
    InvokeAsync(StateHasChanged);
}
                                                                                                                                                                                                 public void Dispose()
        {
            // при уходе со страницы возвращаем List
            CourseEditUi.Changed -= OnUiChanged;
            Ui.SetMode(PageMode.List);
        }
    


    protected override async Task OnInitializedAsync()
    {

         Ui.SetMode(PageMode.Edit);



        if (!IsNew)
        {
            var courseTask = CourseService.GetCourseByIdAsync(Id);
            await courseTask;
            if (courseTask.Result != null)
            {
                Course = courseTask.Result;
                Course.Elements ??= new List<string>();

                // Получаем шаги только если есть элементы
                if (Course.Elements.Count > 0)
                    Steps = await StepService.GetStepsByIdsAsync(Course.Elements);
            }
        }
    }

    private async Task AddStep()
    {
        var step = new Step();
        Steps.Add(step);

        Course.Elements ??= new List<string>();
        Course.Elements.Add(step.Id);

        // Сохраняем новый шаг в базе
        await StepService.CreateStepAsync(step);
    }


    private async Task SaveStep(Step step)
    {
        if (Steps.Any(s => s.Id == step.Id))
            await StepService.UpdateStepAsync(step);
        else
            await StepService.CreateStepAsync(step);
    }

    private async Task DeleteStep(Step step)
    {
        // 1. Удаляем все элементы шага
        foreach (var el in step.Elements)
        {
            if (el.IsTest)
            {
                // Получаем тест
                var test = await TestService.GetTestByIdAsync(el.Id);
                if (test != null)
                {
                    // Удаляем все вопросы теста
                    if (test.Questions != null)
                    {
                        foreach (var qid in test.Questions)
                        {
                            await QuestionService.DeleteQuestionAsync(qid);
                        }
                    }

                    // Удаляем тест
                    await TestService.DeleteTestAsync(el.Id);
                }
            }
            else
            {
                // Если лекция — удаляем через LectureService
                // await LectureService.DeleteLectureAsync(el.Id);
            }
        }

        // 2. Удаляем сам Step
        Steps.Remove(step);
        Course.Elements?.Remove(step.Id);
        await StepService.DeleteStepAsync(step.Id);
    }


    private async Task SaveCourse()
    {
        Course.LastUpdatedAt = DateTime.UtcNow;

        if (IsNew)
            Course.CreatedAt = DateTime.UtcNow;

        // Сохраняем курс и все его шаги/тесты/вопросы через сервис
        await CourseService.SaveCourseAsync(Course, Steps);

        // Переходим обратно к списку
        Ui.SetMode(PageMode.List);
        Navigation.NavigateTo("/Auth");
    }
}
