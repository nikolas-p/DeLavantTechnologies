@using MongoDB.Bson
@using DeLavant.Domain.Steps
@using DeLavant.Domain.Tests
@inject ITestService TestService
@inject IQuestionService QuestionService
@inject IStepService StepService

<div class="item-content">
    <EditForm Model="@Step" OnValidSubmit="SaveStepWithElements" FormName="@FormName">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- HEADER -->
        <div class="item-content-header">
            <div class="item-content-header-left">
                <button type="button" class="circle-button primary-red x-circle-fill-icon" @onclick="DeleteStep"></button>
            </div>
            <div class="item-content-header-center"></div>
            <div class="item-content-header-right">
                <button type="submit" class="circle-button primary-purple check-circle-fill-icon"></button>
            </div>
        </div>

        <!-- MAIN -->
        <div class="item-content-main">
            <InputText class="form-control" @bind-Value="Step.Title" placeholder="Название шага" />
            <InputTextArea class="form-control" @bind-Value="Step.Description" placeholder="Описание (по желанию)" />

            @foreach (var el in Step.Elements)
            {
                <DynamicComponent Type="Resolve(el.IsTest)" Parameters="@(new Dictionary<string, object?>
{
    ["TestId"] = el.Id,
    ["OnDeleted"] = EventCallback.Factory.Create<string>(this, OnElementDeleted)
})" />

            }

            
        </div>

        <!-- FOOTER -->
        <div class="item-content-footer">
            <div class="item-content-footer-center">
                <button class="btn btn-outline-primary btn-sm" type="button" @onclick="AddLecture">Добавить лекцию</button>
                <button class="btn btn-outline-primary btn-sm ms-2" type="button" @onclick="AddTest">Добавить тест</button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public Step Step { get; set; }
    [Parameter] public EventCallback<Step> OnStepUpdated { get; set; }
    [Parameter] public EventCallback<Step> OnStepDeleted { get; set; }

    private string FormName => $"StepForm_{Step.Id}";

    // Локальный словарь для хранения актуальных Test объектов
    private Dictionary<string, Test> TestsCache { get; set; } = new();

    private Type Resolve(bool isTest) => isTest ? typeof(TestEdit) : typeof(LectureEdit);

    private async Task OnElementDeleted(string elementId)
    {
        var element = Step.Elements.FirstOrDefault(e => e.Id == elementId);
        if (element != null)
        {
            Step.Elements.Remove(element);
            await OnStepUpdated.InvokeAsync(Step);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        TestsCache = new Dictionary<string, Test>();

        foreach (var el in Step.Elements.Where(e => e.IsTest))
        {
            var test = await TestService.GetTestByIdAsync(el.Id);
            if (test != null)
            {
                TestsCache[el.Id] = test;
            }
        }
    }


    private async Task SaveStepWithElements()
    {
        // Сохраняем все тесты из локального кеша
        foreach (var el in Step.Elements)
        {
            if (el.IsTest && TestsCache.TryGetValue(el.Id, out var test))
            {
            // Сохраняем тест и его вопросы через TestEdit
            await TestService.SaveTestAsync(test);
                foreach (var q in test.Questions ?? new List<string>())
                {
                    var question = await QuestionService.GetQuestionByIdAsync(q) ?? new Question { Id = q };
                    await QuestionService.SaveQuestionAsync(question);
                }
            }
        }

        // Сохраняем Step
        await StepService.SaveStepAsync(Step);

        // Уведомляем родителя
        await OnStepUpdated.InvokeAsync(Step);
    }

    private async Task DeleteStep()
    {
        foreach (var el in Step.Elements)
        {
            if (el.IsTest)
            {
                if (TestsCache.TryGetValue(el.Id, out var test))
                {
                    // Удаляем вопросы
                    foreach (var qId in test.Questions ?? new List<string>())
                        await QuestionService.DeleteQuestionAsync(qId);

                    // Удаляем тест
                    await TestService.DeleteTestAsync(test.Id);
                }
            }
            else
            {
                // LectureService удаление
            }
        }

        await OnStepDeleted.InvokeAsync(Step);
    }

    private async Task AddLecture()
    {
        Console.WriteLine("Имитация создания лекции");
    }

    private async Task AddTest()
    {
        var test = new Test();
        await TestService.CreateTestAsync(test);

        Step.Elements.Add(new StepElement
            {
                Id = test.Id,
                IsTest = true
            });

        TestsCache[test.Id] = test;
    }

    private void OnTestDeleted(string testId)
    {
        var element = Step.Elements.FirstOrDefault(e => e.Id == testId);
        if (element != null)
        {
            Step.Elements.Remove(element);
            TestsCache.Remove(testId);
            StateHasChanged();
        }
    }

    private void OnTestUpdated(Test test)
    {
        // Обновляем кеш теста
        TestsCache[test.Id] = test;
    }
}
