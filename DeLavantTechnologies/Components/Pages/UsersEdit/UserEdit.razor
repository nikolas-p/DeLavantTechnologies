@page "/users/edit/{Id:guid?}"
@using DeLavantTechnologies.Repositories
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject IPositionRepository PositionRepository
@inject NavigationManager NavigationManager

<h3>@(Id.HasValue ? "Редактировать пользователя" : "Создать пользователя")</h3>

<EditForm EditContext="editContext" OnValidSubmit="Save">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Фамилия</label>
        <InputText class="form-control" @bind-Value="user.LastName" />
    </div>

    <div class="mb-3">
        <label>Имя</label>
        <InputText class="form-control" @bind-Value="user.FirstName" />
    </div>

    <div class="mb-3">
        <label>Отчество</label>
        <InputText class="form-control" @bind-Value="user.MiddleName" />
    </div>

    <div class="mb-3">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="user.Email" />
    </div>

    <div class="mb-3">
        <label>Должности</label>
        <div class="d-flex gap-2 mb-2">
            <select class="form-select" @bind="selectedPositionId">
                <option value="">-- выбрать --</option>
                @foreach (var pos in positions)
                {
                    <option value="@pos.Id">@pos.Name</option>
                }
            </select>
            <button type="button" class="btn btn-sm btn-primary" @onclick="AddPosition">Добавить</button>
        </div>

        <ul>
            @foreach (var posId in user.Positions)
            {
                var pos = positions.FirstOrDefault(p => p.Id == posId);
                if (pos != null)
                {
                    <li>
                        @pos.Name
                        <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemovePosition(pos.Id)">x</button>
                    </li>
                }
            }
        </ul>
    </div>

    <button type="submit" class="btn btn-primary">Сохранить</button>
    <button type="button" class="btn btn-secondary" @onclick="Cancel">Отмена</button>
</EditForm>

@code {
    [Parameter] public Guid? Id { get; set; }

    private ApplicationUser user = new();
    private List<Position> positions = new();
    private Guid? selectedPositionId;
    private EditContext editContext;

    protected override async Task OnInitializedAsync()
    {
        positions = await PositionRepository.GetAllAsync();

        if (Id.HasValue)
        {
            user = await UserManager.FindByIdAsync(Id.Value.ToString()) ?? new ApplicationUser();
        }

        // Убедимся, что Positions не null
        user.Positions ??= new List<Guid>();

        editContext = new EditContext(user);
    }

    private void AddPosition()
    {
        if (selectedPositionId.HasValue && !user.Positions.Contains(selectedPositionId.Value))
        {
            user.Positions.Add(selectedPositionId.Value);
        }
    }

    private void RemovePosition(Guid posId)
    {
        user.Positions.Remove(posId);
    }

    private async Task Save()
    {
        if (!Id.HasValue)
        {
            user.UserName = user.Email;
            await UserManager.CreateAsync(user);
        }
        else
        {
            await UserManager.UpdateAsync(user);
        }

        NavigationManager.NavigateTo("/users");
    }

    private void Cancel() => NavigationManager.NavigateTo("/users");
}
