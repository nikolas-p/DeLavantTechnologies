@using DeLavantTechnologies.Data.Enum
@using DeLavantTechnologies.Repositories
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@rendermode InteractiveServer
@implements IEntityListPage
@inject UserManager<ApplicationUser> UserManager
@inject IPositionRepository PositionRepository
@inject NavigationManager NavigationManager
@inject UiState Ui
@attribute [Authorize(Roles = "Admin")]



    <div class="record-sheet">
        @foreach (var user in FilteredUsers)
    {
        <div class="record-sheet-recording">

            <button class="circle-button primary-red x-circle-fill-icon @(deletePending.ContainsKey(user.Id) ? "pulse" : "")"
            @onclick="() => ToggleUserDelete(user.Id)">
            </button>

            <div class="record-sheet-recording-content">
            <div class="record-sheet-recording" >
               
                <div class="text-block">
                    @user.FirstName @user.LastName @user.MiddleName
                    <br />
                    @user.Email
                    <br />
                    <span>
    @(user.LastLoginTime.HasValue
        ? $"заходил(а) {ToMoscowTime(user.LastLoginTime.Value).ToString("dd.MM HH:mm")}"
        : "не заходил(а)")
</span>

                </div>
            

             <div class="positions-block">
                <div class="centered-element">
                    Должности
                            @{
                                if (userPositions.TryGetValue(user.Id, out var positions))
                                {
                                    foreach(var pos in positions)
                                    {
                                    <div class="item">
                                        @pos
                                     </div>
                                    }    
                                    if(positions.Count ==0)
                                    {
                                    <div class="item">
                                        без должности
                                    </div>
                                    }
                                }
                                else
                                {
                                  
                                }
                            }
                        </div>
                        </div>
                </div>
            </div>

            <button class="circle-button secondary-gray arrow-right-circle-fill-icon"   @onclick="() => Edit(user.Id)"></button>

        </div>
    }

</div>


@code {

    private static DateTime ToMoscowTime(DateTime utcDate)
    {
        var moscowTimeZone = TimeZoneInfo.FindSystemTimeZoneById(
            OperatingSystem.IsWindows() ? "Russian Standard Time" : "Europe/Moscow"
        );

        return TimeZoneInfo.ConvertTimeFromUtc(
            DateTime.SpecifyKind(utcDate, DateTimeKind.Utc),
            moscowTimeZone
        );
    }
    private List<ApplicationUser> users = new();
    private Dictionary<Guid, List<string>> userPositions = new();
    private Dictionary<Guid, CancellationTokenSource> deletePending = new();


    protected override async Task OnInitializedAsync()
    {
        users.Clear();

        foreach (var user in UserManager.Users)
        {
            var roles = await UserManager.GetRolesAsync(user);
            if (!roles.Contains("Ones"))
                users.Add(user);
        }

        var positions = await PositionRepository.GetAllAsync();

        foreach (var user in users)
        {
            userPositions[user.Id] = positions
                .Where(p => user.Positions.Contains(p.Id.ToString()))
                .Select(p => p.Name)
                .ToList();
        }
    }

    void Edit(Guid id) => NavigationManager.NavigateTo($"/users/edit/{id}");

    private void ToggleUserDelete(Guid userId)
    {
        if (deletePending.ContainsKey(userId))
        {
            // Отмена удаления
            deletePending[userId].Cancel();
            deletePending.Remove(userId);
            StateHasChanged();
            return;
        }

        var cts = new CancellationTokenSource();
        deletePending[userId] = cts;
        StateHasChanged();

        _ = DeleteUserWithDelay(userId, cts.Token);
    }


    private async Task DeleteUserWithDelay(Guid userId, CancellationToken token)
    {
        try
        {
            await Task.Delay(5000, token);
            await DeleteUser(userId);
        }
        catch (TaskCanceledException)
        {
            // пользователь отменил
        }
        finally
        {
            if (deletePending.ContainsKey(userId))
            {
                deletePending.Remove(userId);
                StateHasChanged();
            }
        }
    }


    private async Task DeleteUser(Guid userId)
    {
        var user = await UserManager.FindByIdAsync(userId.ToString());
        if (user is null)
            return;

        await UserManager.DeleteAsync(user);

        users.RemoveAll(u => u.Id == userId);
        userPositions.Remove(userId);

        StateHasChanged();
    }


    [Parameter] public string Search { get; set; } = "";
    [Parameter] public Dictionary<string, object> Parameters { get; set; } = new();

    IEnumerable<ApplicationUser> FilteredUsers
    {
        get
        {
            IEnumerable<ApplicationUser> query = users;

            /* ===== ПОИСК ===== */
            var search = Ui.CurrentState.Search;
        if (!string.IsNullOrWhiteSpace(search))
        {
            var s = search.Trim();

            query = query.Where(u =>
                (!string.IsNullOrEmpty(u.LastName) &&
                 u.LastName.Contains(s, StringComparison.OrdinalIgnoreCase))
             || (!string.IsNullOrEmpty(u.FirstName) &&
                 u.FirstName.Contains(s, StringComparison.OrdinalIgnoreCase))
             || (!string.IsNullOrEmpty(u.MiddleName) &&
                 u.MiddleName.Contains(s, StringComparison.OrdinalIgnoreCase))
            );
        }

            /* ===== СОРТИРОВКА ===== */
            if (Ui.CurrentState.Parameters.TryGetValue("order", out var orderObj)
                && orderObj is UserOrder order)
            {
                query = order switch
                 {
                    UserOrder.AZName => query.OrderBy(u => u.LastName),
                    UserOrder.ZAName => query.OrderByDescending(u => u.LastName),
                    UserOrder.LastDateLoginToNew => query.OrderBy(u=>u.LastLoginTime),
                    UserOrder.LastDateLoginToOld => query.OrderByDescending(u => u.LastLoginTime),
                    _ => query
                };
            }

            return query;
        }
    }
}
