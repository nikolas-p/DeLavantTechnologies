@using MongoDB.Bson
@using DeLavant.Domain.Tests
@inject ITestService TestService
@inject IQuestionService QuestionService
@rendermode InteractiveServer

@if (Question != null)
{
    <div class="item-content">
        <!-- HEADER -->
        <div class="item-content-header">
            <div class="item-content-header-left">
                <button class="circle-button primary-red x-circle-fill-icon" type="button"  @onclick="Delete"></button>
            </div>
            <div class="item-content-header-center">
                <h6>Один ответ</h6>
            </div>
            <div class="item-content-header-right">
                <button class="circle-button primary-purple check-circle-fill-icon" type="button" @onclick="Save"></button>
            </div>
        </div>

        <!-- MAIN -->
        <div class="item-content-main">

            <InputText class="form-control" @bind-Value="Question.Title" placeholder="Текст вопроса" @onblur="async _ => await Save()" />
            @if (Question.Answers == null || !Question.Answers.Any())
            {
                <p>Ответы отсутствуют</p>
            }
            else
            {
                
                    <InputRadioGroup @bind-Value="SelectedAnswerId"
                    Name="@($"radio-{Question.Id}")">

                        <div class="column">
                        @foreach (var answer in Question.Answers)
                        {
                             <div class="column-row-item" @key="answer.Id">
                                <InputRadio Value="answer.Id" class="radio-input"/>
                                <InputTextArea  @bind-Value="answer.Value" @onblur="async _ => await Save()" />
                                <button class="circle-button primary-red x-circle-fill-icon" type="button" @onclick="() => RemoveAnswer(answer.Id)">x</button>
                            </div>
                        }
                         </div>
                    </InputRadioGroup> 
               
            }

        </div>

        <!-- FOOTER -->
        <div class="item-content-footer">
            <div class="item-content-footer-center">
                <button class="btn btn-sm btn-outline-primary mt-1" type="button" @onclick="AddAnswer">Добавить ответ</button>
            </div>
        </div>

    </div>
    <div>

    </div>
}
else
{
    <h3>Создавайте</h3>
}

@code {
    [Parameter] public Question Question { get; set; }
    [Parameter] public EventCallback<Question> OnQuestionUpdated { get; set; }
    [Parameter] public EventCallback<string> OnQuestionDeleted { get; set; }

    private async Task OnCorrectAnswerChanged(string value)
    {
        SelectedAnswerId = value;
        await Save();
    }

    private string SelectedAnswerId
    {
        get => Question.Answers.FirstOrDefault(a => a.IsCorrect)?.Id;
        set
        {
            foreach (var a in Question.Answers)
                a.IsCorrect = a.Id == value;

            _ = Save(); // fire-and-forget
        }
    }

    private void AddAnswer()
    {
        Question.Answers ??= new List<Answer>();
        Question.Answers.Add(new Answer
            {
                Id = ObjectId.GenerateNewId().ToString(),
                Value = "",
                IsCorrect = false
            });
    }

    private void RemoveAnswer(string id)
    {
        var ans = Question.Answers.FirstOrDefault(a => a.Id == id);
        if (ans != null) Question.Answers.Remove(ans);
        Save();
    }

    private async Task Save()
    {
        if (Question == null) return;

        // Сохраняем сам вопрос в БД
        await QuestionService.SaveQuestionAsync(Question);
        await OnQuestionUpdated.InvokeAsync(Question);
        Console.WriteLine($"Save change {Question.Id}");
    }

    private async Task Delete()
    {
        await QuestionService.DeleteQuestionAsync(Question.Id);
        await OnQuestionDeleted.InvokeAsync(Question.Id);
    }
}
